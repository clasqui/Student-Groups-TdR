"use strict";angular.module("stugrApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ui.router","ui.bootstrap"]).config(["$urlRouterProvider","$stateProvider","USER_ROLES",function(a,b,c){a.otherwise("/");var d={auth:!0,authorizedRoles:[c.coord,c.professor,c.alumne]};b.state("anon",{"abstract":!0,data:{auth:!1}}).state("anon.login",{url:"/login",views:{"login@":{templateUrl:"partials/logIn.html"}},controller:"AppCtrl",data:{}}).state("home",{url:"/",controller:"MainCtrl",templateUrl:"views/main.html",data:{auth:!0,authorizedRoles:[c.coord,c.professor,c.alumne]}}).state("dashboard",{url:"/admin",templateUrl:"views/admin.html",controller:"AdminCtrl",data:{auth:!0,authorizedRoles:[c.coord]}}).state("courses",{url:"/cursos",templateUrl:"views/group.html",data:d,controller:"GroupCtrl"}).state("courseDetail",{url:"/courses/:id",templateUrl:"views/groupdetail.html",data:d,controller:"GroupCtrl"}).state("profile",{url:"/perfil",template:"<h1>El teu perfil</h1>",data:{auth:!0,authorizedRoles:[c.coord,c.professor,c.alumne]}})}]).run(["$rootScope","Session","USER_ROLES","AUTH_EVENTS","Userservice","$state","StugrUser",function(a,b,c,d,e,f,g){console.log("$stateChangeSuccess");var h=Parse.User.current();h?(console.log("We have a session"),console.log(h),b.create(h._sessionToken,h),a.currentUser=h):b.destroy(),a.$on("$stateChangeStart",function(b,c,g,h,i){if(console.log("$stateChangeStart"),console.log(c),c.data.auth){var j=c.data.authorizedRoles;e.isAuthorized(j)||(console.log("Not Authorized"),b.preventDefault(),e.isAuthenticated()?(a.$broadcast(d.notAuthorized),f.go("home")):(console.log("User is not logged in"),a.$broadcast(d.notAuthenticated),f.go("anon.login")))}})}]),angular.module("stugrApp").controller("AdminCtrl",["$scope","$rootScope","Userservice",function(a,b,c){a.statusText="Tots els sistemes funcionen correctament, no hi ha hagut incidències avui.",a.statusShow=!0,a.newUser={username:"",email:"",first_name:"",last_name:"",type:""},a.doCreate=function(){var b=Math.random().toString(36).slice(-8),d=parseInt(a.newUser.type);console.log("The typeID as extracted is: "+d),delete a.newUser.type,a.newUser.password=b,c.createUser(a.newUser,d).then(function(b){var c=["Alumne","Professor","Coordinador"];a.statusText="User "+b.id+"successfully registered",a.statusShow=!0,console.log("User Successfully registered, tell them to check their email."),a.newUser.type=c[d],Parse.Cloud.run("sendEmailWithPassword",a.newUser,{success:function(a){console.log("Email sent. response: "+a)},error:function(a){console.log("mail error: "+a)}})},function(a){console.log("failed registration: ",a)},function(a){console.log("update something: ",a)})}}]),angular.module("stugrApp").controller("AppCtrl",["$rootScope","$scope","$location","Userservice","StugrUser","AUTH_EVENTS","USER_ROLES","$state","Session",function(a,b,c,d,e,f,g,h,i){b.userCredentials={username:"",password:"",email:"",first_name:"",last_name:""},b.registerUserMode=!1,a.codename="Student Groups",b.showRegistrationForm=function(){b.registerUserMode=!0},b.currentUser=a.currentUser,b.userRoles=g,b.isAuthorized=d.isAuthorized,b.isLoggedIn=d.isAuthenticated,console.log(d.isAuthenticated()),b.setCurrentUser=function(c){a.currentUser=c,b.currentUser=c},b.doLogin=function(){console.log("Login Credentials: ",b.userCredentials),d.login(b.userCredentials).then(function(c){console.log("Successful login",c),a.$broadcast(f.loginSuccess),b.setCurrentUser(Parse.User.current()),h.go("home")},function(b){console.log("Failed Login: ",b),a.$broadcast(f.loginFailed)})},b.doRegister=function(){d.register().then(function(a){var c=new Parse.User;for(var d in b.userCredentials)c.set(d,b.userCredentials[d]);c.set("coordinador",a),c.signUp(null,{success:function(a){console.log("User "+a.id+" successfully registered!"),b.userCredentials.type="Coordinador",Parse.Cloud.run("sendEmailWithPassword",b.userCredentials,{success:function(a){console.log("Email sent. response: "+a)},error:function(a){console.log("mail error: "+a)}})},error:function(a,b){console.log("failed registration: ",b)}})},function(a){console.log("Could not save the link object, error: "+a.code)})},b.doLogOut=function(){d.logOut(),document.location.reload(),h.go("anon.login")}}]),angular.module("stugrApp").controller("GroupCtrl",["$rootScope","$scope","GroupModel","Userservice","USER_ROLES","$stateParams",function(a,b,c,d,e,f){b.isAuthorized=d.isAuthorized,b.userRoles=e,c.getGroups().then(function(a){b.myGroups=a},function(a){console.log(a)}),b.searchData="",b.groupData={nom:"",alumnes:[]},b.createGroup=function(){c.createGroup(b.groupData.nom),b.myGroups.push(b.groupData)},f.id&&c.getGroupWithId(f.id).then(function(a){b.groupData=a},function(a){console.log(a)})}]),angular.module("stugrApp").controller("MainCtrl",["$scope","$rootScope","Userservice",function(a,b,c,d){c.isAuthenticated()?a.motd="Hola, "+b.currentUser.get("first_name")+"!  El teu compte és de tipus "+b.currentUser.role():a.motd="Not Logged In!!"}]),angular.module("stugrApp").factory("GroupModel",["$rootScope","$q","USER_ROLES",function(a,b,c){var d=Parse.Object.extend("Grup");d.prototype.__defineGetter__("nom",function(){return this.get("nom")}),d.prototype.__defineSetter__("nom",function(a){return this.set("nom",a)}),d.prototype.__defineGetter__("alumnes",function(){return this.get("alumnes")}),d.prototype.__defineSetter__("alumnes",function(a){return this.set("alumnes",a)}),d.prototype.__defineGetter__("Professor",function(){return this.get("Professor")}),d.prototype.__defineSetter__("Professor",function(a){return this.set("Professor",a)});var e={};return e.createGroup=function(b){var c=new d;c.set("nom",b),c.set("Professor",a.currentUser),c.save(null,{success:function(a){console.log("New group object Created")},error:function(a,b){console.log("Failed to create new object, with error code: "+b.message)}})},e.getGroups=function(){var e=new Parse.Query(d),f=b.defer();return a.currentUser.role()!=c.alumne?(console.log("Getting courses of this teacher"),e.equalTo("Professor",Parse.User.current()),e.find({success:function(a){console.log(a.length),f.resolve(a)},error:function(a){f.reject(a)}}),f.promise):void 0},e.getGroupWithId=function(a){var c=new Parse.Query(d),e=b.defer();return c.equalTo("objectId",a),c.include("alumnes.first_name"),c.include("Professor"),c.first().then(function(a){console.log(a),e.resolve(a)},function(a){e.reject(a)}),e.promise},e}]),angular.module("stugrApp").service("Session",["USER_ROLES",function(a){this.create=function(a,b){this.id=a,this.userId=b,this.userRole=b.role()},this.destroy=function(){this.id=null,this.userId=null,this.userRole=null}}]),angular.module("stugrApp").factory("StugrUser",["$rootScope","Userservice","USER_ROLES",function(a,b,c){var d=Parse.User.extend({role:function(){console.log("Getting role with the extended method");var a;return a=this.get("coordinador")?c.coord:this.get("professor")?c.professor:c.alumne}},{});return d}]),angular.module("stugrApp").service("Userservice",["$rootScope","Session","USER_ROLES","$state",function(a,b,c,d){var e={};return e.login=function(a){return Parse.User.logIn(a.username,a.password).then(function(a){return console.log(a),b.create(a.sessionToken,Parse.User.current()),a})},e.isAuthenticated=function(){return!!b.userId},e.isAuthorized=function(a){return angular.isArray(a)||(a=[a]),e.isAuthenticated()&&-1!==a.indexOf(b.userRole)},e.register=function(){var a=Parse.Object.extend("Coordinador"),b=new a;return b.save(null)},e.createUser=function(a,b){var c=["Alumne","Professor","Coordinador"],d=["alumne","professor","coordinador"],e=Parse.Object.extend(c[b]),f=new e,g=new Parse.User;f.save(null,{success:function(c){for(var e in a)g.set(e,a[e]);return g.set(d[b],c),console.log("Executing line: user.set("+d[b]+", "+c+"); "),g.signUp(null)},error:function(a,b){console.log("Could not save the link object: "+b)}})},e.logOut=function(){Parse.User.logOut(),b.destroy(),d.go("anon.login")},e}]).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{coord:"coord",professor:"professor",alumne:"alumne"});